<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日作業員工時明細表產生器</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            line-height: 1.4;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            font-size: 2.2em;
            line-height: 1.3;
        }
        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 32px;
            text-align: center;
            margin-bottom: 25px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            line-height: 1.4;
        }
        .upload-area:hover {
            background: #e9ecef;
            border-color: #2980b9;
        }
        .upload-area.dragover {
            background: #d4edda;
            border-color: #28a745;
        }
        input[type="file"] {
            display: none;
        }
        .upload-btn, .process-btn, .download-btn {
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
        }
        .upload-btn:hover, .process-btn:hover, .download-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        .process-btn {
            background: #27ae60;
            width: 100%;
            font-size: 18px;
            font-weight: bold;
            padding: 12px 25px;
            margin: 16px 0;
        }
        .process-btn:hover {
            background: #229954;
        }
        .process-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        .download-btn {
            background: #e74c3c;
        }
        .download-btn:hover {
            background: #c0392b;
        }
        .results {
            margin-top: 25px;
            padding: 18px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #3498db;
            line-height: 1.4;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 16px 0;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            line-height: 1.2;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }
        .stat-label {
            color: #7f8c8d;
            margin-top: 5px;
        }
        .sample-data {
            background: white;
            border-radius: 10px;
            padding: 16px;
            margin-top: 16px;
            overflow-x: auto;
            line-height: 1.3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            line-height: 1.3;
        }
        th {
            background: #f1f2f6;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .warning-icon {
            color: #e74c3c;
            font-weight: bold;
            margin-right: 5px;
            font-size: 1.2em;
        }
        .abnormal-row {
            background-color: #fff5f5;
        }
        .hours-cell {
            font-weight: bold;
        }
        .abnormal-hours {
            color: #e74c3c;
        }
        .normal-hours {
            color: #27ae60;
        }
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        .csv-output {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 16px;
            color: #7f8c8d;
            font-size: 14px;
            border-top: 1px solid #ecf0f1;
        }
        .footer .sparkle {
            color: #f39c12;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📊 每日作業員工時明細表產生器</h1>
        
        <div class="upload-area" id="uploadArea">
            <h3>📁 請選擇或拖拽 MES 工單人員記錄表檔案</h3>
            <p>支援格式: Excel (.xlsx, .xls)</p>
            <input type="file" id="fileInput" accept=".xlsx,.xls">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                選擇檔案
            </button>
            <div id="fileName" style="margin-top: 15px; font-weight: bold; color: #2c3e50;"></div>
        </div>

        <button class="process-btn" id="processBtn" onclick="processFile()" disabled>
            🔄 開始處理並產生報表
        </button>

        <div id="filterArea" class="results" style="display: none;">
            <h3>🔍 篩選條件</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label for="dateSelect">選擇日期：</label>
                    <select id="dateSelect">
                        <option value="">全部日期</option>
                    </select>
                </div>
                <div>
                    <label for="factorySelect">選擇廠別：</label>
                    <select id="factorySelect">
                        <option value="">全部廠別</option>
                    </select>
                </div>
            </div>
            <button class="process-btn" onclick="applyFilters()" style="background: #f39c12;">
                📋 套用篩選並顯示結果
            </button>
        </div>

        <div id="results" class="results" style="display: none;">
            <h3>📈 篩選結果</h3>
            <div id="resultsContent"></div>
        </div>
        
        <div class="results" style="margin-top: 20px;">
            <h3>📋 資料處理排除規則說明</h3>
            <div style="background: white; border-radius: 10px; padding: 16px; line-height: 1.5;">
                <p><strong>系統會自動排除以下類型的記錄：</strong></p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li><strong>缺少必要資料：</strong>員工姓名、開始生產時間、結束生產時間任一欄位為空白的記錄</li>
                    <li><strong>時間差過短：</strong>「結束時間」減去「開始時間」在10秒內的記錄（例如：時間差為5秒的記錄將被完全忽略，不會出現在任何統計中）</li>
                </ul>
                <p><strong>資料合併規則：</strong></p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>同一員工在同一天同一廠別的多筆記錄會合併為一筆</li>
                    <li>開始時間取最早時間，結束時間取最晚時間</li>
                    <li>設備欄位會收集所有使用的設備代碼，用分號(;)分隔</li>
                </ul>
                <p><strong>異常工時判定：</strong></p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>工作時間少於8小時或超過13小時視為異常</li>
                </ul>
            </div>
        </div>
        
        <div class="footer">
            <span class="sparkle">✨</span>Learn with Tarshar — 2025
        </div>
    </div>

    <script>
// ========= 1️⃣ 在主程式最前面，Excel 讀取之前 =========
// 所有員工資料寫在程式裡
const employees =[
        { name: "自動機台_博士01", dept: "博士廠_成型" },
      { name: "自動機台_博士02", dept: "博士廠_成型" },
      { name: "自動機台_博士03", dept: "博士廠_成型" },
      { name: "林秀富P021", dept: "博士廠(技術員)" },
      { name: "藍士添P018", dept: "博士廠(技術員)" },
      { name: "陳俊翰P030", dept: "博士廠(技術員)" },
      { name: "劉進龍P004", dept: "博士廠(技術員)" },
      { name: "林月美P011", dept: "博士廠_成型" },
      { name: "郭氏玄P019", dept: "博士廠_成型" },
      { name: "黃氏玉P069", dept: "博士廠_成型" },
      { name: "范金線P016", dept: "博士廠_成型" },
      { name: "阮玉越P029", dept: "博士廠_成型" },
      { name: "林源富P009", dept: "博士廠(技術員)" },
      { name: "蔡鈺伶P075", dept: "博士廠_成型" },
      { name: "蘇辛和P066", dept: "博士廠(技術員)" },
      { name: "羅珍娜P077", dept: "博士廠_成型" },
      { name: "張景鴻P032", dept: "博士廠(技術員)" },
      { name: "黃鳴詩P071", dept: "博士廠_成型" },
      { name: "阮芳翠P106", dept: "博士廠_成型" },
      { name: "林雅雯P020", dept: "博士廠_成型" },
      { name: "塔瓦P081", dept: "博士廠_成型" },
      { name: "阿卡盧P095", dept: "博士廠_成型" },
      { name: "提彭P093", dept: "博士廠_成型" },
      { name: "羅同P064", dept: "博士廠_成型" },
      { name: "塔松P049", dept: "博士廠_成型" },
      { name: "恰尼P096", dept: "博士廠_成型" },
      { name: "彭班迪P065", dept: "博士廠_成型" },
      { name: "柯猜P084", dept: "博士廠_成型" },
      { name: "那達朋", dept: "博士廠_成型" },
      { name: "桑弟P045", dept: "博士廠_成型" },
      { name: "瓦堤肯P104", dept: "博士廠_成型" },
      { name: "習立P043", dept: "博士廠_成型" },
      { name: "拉他朋P044", dept: "博士廠_成型" },
      { name: "楚沙克P103", dept: "博士廠_成型" },
      { name: "尤他那P055", dept: "博士廠_成型" },
      { name: "馬南P092", dept: "博士廠_成型" },
      { name: "布寇P083", dept: "博士廠_成型" },
      { name: "孟昆P054", dept: "博士廠_成型" },
      { name: "塔納瓦P082", dept: "博士廠_成型" },
      { name: "皮塔亞P038", dept: "博士廠_成型" },
      { name: "皮沙努P061", dept: "博士廠_成型" },
      { name: "孔恩P063", dept: "博士廠_成型" },
      { name: "查帕迪P105", dept: "博士廠_成型" },
      { name: "蘇帕空P109", dept: "博士廠_成型" },
      { name: "坤比塔P085", dept: "博士廠_成型" },
      { name: "德查P086", dept: "博士廠_成型" },
      { name: "普塔奈P087", dept: "博士廠_成型" },
      { name: "阿卡帕P090", dept: "博士廠_成型" },
      { name: "蒙空P091", dept: "博士廠_成型" },
      { name: "陳秀華A062", dept: "博士廠_組裝" },
      { name: "洪麗雪A063", dept: "博士廠_組裝" },
      { name: "楊美淑A065", dept: "博士廠_組裝" },
      { name: "張育禎A068", dept: "博士廠_組裝" },
      { name: "段素玉A099", dept: "博士廠_組裝" },
      { name: "金玉夏A096", dept: "博士廠_組裝" },
      { name: "楊雅雲A085", dept: "博士廠_組裝" },
      { name: "杜佩儀A083", dept: "博士廠_組裝" },
      { name: "金玉雲A066", dept: "博士廠_組裝" },
      { name: "武笎蓁A090", dept: "博士廠_組裝" },
      { name: "阮金鳳A098", dept: "博士廠_組裝" },
      { name: "胡玉美A080", dept: "博士廠_組裝" },
      { name: "林壽珠A058", dept: "博士廠_組裝" },
      { name: "陳美玉A076", dept: "博士廠_組裝" },
      { name: "楊美玲A056", dept: "博士廠_組裝" },
      { name: "任江慧A057", dept: "博士廠_組裝" },
      { name: "吳麗萍A075", dept: "博士廠_組裝" },
      { name: "郭玲君A061", dept: "博士廠_組裝" },
      { name: "蘇明慶", dept: "宗瑋廠(技術員)" },
      { name: "張慶城P002", dept: "宗瑋廠(技術員)" },
      { name: "伍弘宇P005", dept: "宗瑋廠(技術員)" },
      { name: "黃子芸P006", dept: "宗瑋廠_成型" },
      { name: "林佳蓉P007", dept: "宗瑋廠_成型" },
      { name: "廖信閔P027", dept: "宗瑋廠(技術員)" },
      { name: "陳美惠P028", dept: "宗瑋廠_成型" },
      { name: "阮氏容P026", dept: "宗瑋廠_成型" },
      { name: "羅完金P023", dept: "宗瑋廠_成型" },
      { name: "阮金英P022", dept: "宗瑋廠_成型" },
      { name: "胡萬福P010", dept: "宗瑋廠(技術員)" },
      { name: "李阮穗真P073", dept: "宗瑋廠_成型" },
      { name: "裴玉萍P034", dept: "宗瑋廠_成型" },
      { name: "阮清翠P072", dept: "宗瑋廠_成型" },
      { name: "陳達和P003", dept: "宗瑋廠(技術員)" },
      { name: "裴氏垂莊P035", dept: "宗瑋廠_成型" },
      { name: "韋姿伶P014", dept: "宗瑋廠_成型" },
      { name: "阮春蘭P017", dept: "宗瑋廠_成型" },
      { name: "陳氏金芝P070", dept: "宗瑋廠_成型" },
      { name: "陳忠勇P031", dept: "宗瑋廠(技術員)" },
      { name: "馮聖崴P015", dept: "宗瑋廠(技術員)" },
      { name: "陳氏梅P025", dept: "宗瑋廠_成型" },
      { name: "阮金心P024", dept: "宗瑋廠_成型" },
      { name: "丁氏邊P074", dept: "宗瑋廠_成型" },
      { name: "袁揮閎P080", dept: "宗瑋廠(技術員)" },
      { name: "潘莉欣P108", dept: "宗瑋廠_成型" },
      { name: "高氏銀P079", dept: "宗瑋廠_成型" },
      { name: "阮氏翠姮P033", dept: "宗瑋廠_成型" },
      { name: "蔡秀慧", dept: "宗瑋廠_成型" },
      { name: "武春百P040", dept: "宗瑋廠_成型" },
      { name: "陳青風P088", dept: "宗瑋廠_成型" },
      { name: "武維海P057", dept: "宗瑋廠_成型" },
      { name: "陳文勻P041", dept: "宗瑋廠_成型" },
      { name: "杜春興P050", dept: "宗瑋廠_成型" },
      { name: "阮清豐P052", dept: "宗瑋廠_成型" },
      { name: "童偉全P058", dept: "宗瑋廠_成型" },
      { name: "裴維慶P060", dept: "宗瑋廠_成型" },
      { name: "阮文正P046", dept: "宗瑋廠_成型" },
      { name: "趙清選P094", dept: "宗瑋廠(技術員)" },
      { name: "楊明全P053", dept: "宗瑋廠_成型" },
      { name: "阮黃英P099", dept: "宗瑋廠_成型" },
      { name: "鄭玉英P062", dept: "宗瑋廠_成型" },
      { name: "阮俊英P039", dept: "宗瑋廠_成型" },
      { name: "楊明新P048", dept: "宗瑋廠_成型" },
      { name: "丁光高P047", dept: "宗瑋廠_成型" },
      { name: "陳家康P059", dept: "宗瑋廠_成型" },
      { name: "蕃庭元P098", dept: "宗瑋廠_成型" },
      { name: "阮明君P097", dept: "宗瑋廠_成型" },
      { name: "黃高強P100", dept: "宗瑋廠_成型" },
      { name: "潘越英P051", dept: "宗瑋廠_成型" },
      { name: "黎長詩P042", dept: "宗瑋廠_成型" },
      { name: "裴光信", dept: "宗瑋廠_成型" },
      { name: "趙進水P056", dept: "宗瑋廠_成型" },
      { name: "鄭明姝A054", dept: "宗瑋廠_組裝" },
      { name: "陳秀娟A059", dept: "宗瑋廠_組裝" },
      { name: "鍾玉琴A070", dept: "宗瑋廠_組裝" },
      { name: "李昌蘭A073", dept: "宗瑋廠_組裝" },
      { name: "盧秀貞A087", dept: "宗瑋廠_組裝" },
      { name: "李曉旭A074", dept: "宗瑋廠_組裝" },
      { name: "黃韋佩娟A092", dept: "宗瑋廠_組裝" },
      { name: "溫欣怡A097", dept: "宗瑋廠_組裝" },
      { name: "葉惠娟A064", dept: "宗瑋廠_組裝" },
      { name: "周蘭芳A082", dept: "宗瑋廠_組裝" },
      { name: "范以晴A081", dept: "宗瑋廠_組裝" },
      { name: "黃氏翠瑩A100", dept: "宗瑋廠_組裝" },
      { name: "許惠敏A094", dept: "宗瑋廠_組裝" },
      { name: "李玲旋A069", dept: "宗瑋廠_組裝" },
      { name: "劉麗芳A093", dept: "宗瑋廠_組裝" },
      { name: "陳碧A088", dept: "宗瑋廠_組裝" },
      { name: "蔡美祺A078", dept: "宗瑋廠_組裝" },
      { name: "王昱雯A091", dept: "宗瑋廠_組裝" },
      { name: "邱雅玲A079", dept: "宗瑋廠_組裝" },
      { name: "吳琴琴A104", dept: "宗瑋廠_組裝" },
      { name: "簡明章A095", dept: "宗瑋廠_組裝" },
      { name: "李雪君A060", dept: "宗瑋廠_組裝" },
      { name: "范金玉A071", dept: "宗瑋廠_組裝" },
      { name: "何家瑜A052", dept: "宗瑋廠_組裝" },
      { name: "錢巧菁A086", dept: "宗瑋廠_組裝" },
      { name: "阮氏芳鶯A055", dept: "宗瑋廠_組裝" }
];
// 篩選函式，加在原本顯示前
function filterByEmployeeAndFactory(attendanceList, selectedFactory) {
    return attendanceList.filter(att => 
        att.factory === selectedFactory && 
        employeeList.some(emp => emp.name === att.name && emp.factory === att.factory)
    );
}

// 原本顯示上工的程式（假設是這樣）
function displayAttendance(attendanceList, selectedFactory) {
    // 加上篩選
    const filteredList = filterByEmployeeAndFactory(attendanceList, selectedFactory);

    // 以下保持原本顯示邏輯
    filteredList.forEach(att => {
        // 原本的 DOM 顯示程式
        console.log(att.name); // 或者你的表格填充程式
    });
}
// ========= 2️⃣ 你原本的程式讀 Excel 上下工紀錄 =========
// records = ... 這裡讀 Excel
        
        let allProcessedData = null;
        let processedData = null;

        // 日期格式化函數 - 修正為 YYYY/MM/DD 格式
        function formatDate(dateStr) {
            if (!dateStr) return '';
            
            // 如果已經是 YYYY/MM/DD 格式，直接返回
            if (typeof dateStr === 'string' && dateStr.match(/^\d{4}\/\d{2}\/\d{2}$/)) {
                return dateStr;
            }
            
            // 如果是 YYYY/M/D 格式，補零
            if (typeof dateStr === 'string' && dateStr.match(/^\d{4}\/\d{1,2}\/\d{1,2}$/)) {
                const parts = dateStr.split('/');
                const year = parts[0];
                const month = parts[1].padStart(2, '0');
                const day = parts[2].padStart(2, '0');
                return `${year}/${month}/${day}`;
            }
            
            // 嘗試解析為日期物件
            try {
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}/${month}/${day}`;
                }
            } catch (e) {
                console.warn('無法解析日期:', dateStr);
            }
            
            return dateStr;
        }

        // 資料排序函數 - 先依異常狀況排序，再依工時數值排序
        function sortData(data) {
            return data.sort((a, b) => {
                // 第一優先：異常狀況排序（異常在前）
                if (a.異常狀況 !== b.異常狀況) {
                    return b.異常狀況 - a.異常狀況; // true(1) 在前，false(0) 在後
                }
                
                // 第二優先：工時數值由少到多
                return a.工時數值 - b.工時數值;
            });
        }

        // 檔案拖拽處理
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            uploadArea.classList.add('dragover');
        }

        function unhighlight(e) {
            uploadArea.classList.remove('dragover');
        }

        uploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        fileInput.addEventListener('change', function(e) {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                document.getElementById('fileName').textContent = `已選擇: ${file.name}`;
                document.getElementById('processBtn').disabled = false;
                window.selectedFile = file;
            }
        }

        async function processFile() {
            if (!window.selectedFile) {
                alert('請先選擇檔案');
                return;
            }

            const filterArea = document.getElementById('filterArea');
            filterArea.style.display = 'block';
            
            filterArea.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>正在處理資料，請稍候...</p>
                </div>
            `;

            try {
                const arrayBuffer = await window.selectedFile.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const originalWorkbook = XLSX.read(data, { type: 'array' });
                
                const firstSheetName = originalWorkbook.SheetNames[0];
                const worksheet = originalWorkbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                const headers = jsonData[0];
                console.log('Excel 標題行:', headers);
                
                // 根據實際的Excel檔案結構調整欄位索引
                // 從分析結果看，欄位順序是：日期, 員工代號, 員工姓名, 製程, 設備代碼, 設備名稱, 工單單號, 生產批號, 產品編號, 產品名稱, 開始生產時間, 結束生產時間, 工時
                const records = jsonData.slice(1).filter(row => {
                    // 基本資料檢查：員工姓名, 開始生產時間, 結束生產時間
                    if (!row[2] || !row[10] || !row[11]) return false;
                    
                    // 排除條件：忽略結束時間與開始時間差距在10秒內的記錄
                    const startTime = new Date(row[10]);
                    const endTime = new Date(row[11]);
                    const timeDiffSeconds = (endTime - startTime) / 1000;
                    
                    return timeDiffSeconds > 10; // 只保留時間差大於10秒的記錄
                });
                
                const dailyStats = {};

                records.forEach(row => {
                    const dateValue = row[0]; // 日期欄位
                    const employeeName = row[2]; // 員工姓名
                    const equipmentCode = row[4]; // 設備代碼
                    const equipmentName = row[5]; // 設備名稱
                    const workOrderNo = row[6]; // 工單單號
                    const startTime = row[10]; // 開始生產時間
                    const endTime = row[11]; // 結束生產時間
                    
                    let factory = '其他';
                    if (workOrderNo) {
                        const prefix = workOrderNo.toString().substring(0, 4);
                        switch(prefix) {
                            case 'GE11': factory = '宗瑋廠_成型'; break;
                            case 'DE11': factory = '博士廠_成型'; break;
                            case 'GE31': factory = '宗瑋廠_組裝'; break;
                            case 'DE31': factory = '博士廠_組裝'; break;
                        }
                    }
                    
                    // 處理設備資訊 - 只顯示設備代碼
                    let equipment = '';
                    if (equipmentCode) {
                        equipment = equipmentCode;
                    }
                    
                    // 使用日期欄位的值，如果是字串格式則直接使用，否則從開始時間提取日期
                    let workDate;
                    if (dateValue && typeof dateValue === 'string' && dateValue.includes('/')) {
                        workDate = formatDate(dateValue);
                    } else {
                        // 從開始時間提取日期
                        workDate = formatDate(new Date(startTime));
                    }
                    
                    const key = `${employeeName}_${workDate}_${factory}`;
                    
                    if (!dailyStats[key]) {
                        dailyStats[key] = {
                            員工姓名: employeeName,
                            廠別: factory,
                            工作日期: workDate,
                            開始時間: startTime,
                            結束時間: endTime,
                            設備: equipment ? [equipment] : []
                        };
                    } else {
                        if (new Date(startTime) < new Date(dailyStats[key].開始時間)) {
                            dailyStats[key].開始時間 = startTime;
                        }
                        if (new Date(endTime) > new Date(dailyStats[key].結束時間)) {
                            dailyStats[key].結束時間 = endTime;
                        }
                        // 收集設備資訊，避免重複
                        if (equipment && !dailyStats[key].設備.includes(equipment)) {
                            dailyStats[key].設備.push(equipment);
                        }
                    }
                });
// ===== 在這裡新增無上工紀錄 =====
Object.keys(employees).forEach(id => {
    // 假設 employees 是你放在程式裡的員工資料物件，格式：{工號: 姓名, ...}
    const name = employees[id];

    // 檢查 dailyStats 是否已有該員工資料
    const hasRecord = Object.values(dailyStats).some(stat => stat.員工姓名 === name);
    if (!hasRecord) {
        // 隨便給個日期，例如今天，或保留空字串
        const workDate = '';
        const factory = '';
        dailyStats[`${name}_${workDate}_${factory}`] = {
            員工姓名: name,
            廠別: factory,
            工作日期: workDate,
            開始時間: '',
            結束時間: '',
            設備: []
        };
    }
});

                const results = [];
                Object.values(dailyStats).forEach(stat => {
                    const start = new Date(stat.開始時間);
                    const end = new Date(stat.結束時間);
                    const hoursDiff = (end - start) / (1000 * 60 * 60);
                    
                    const startTimeStr = start.toLocaleTimeString('zh-TW', { 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        hour12: false 
                    });
                    const endTimeStr = end.toLocaleTimeString('zh-TW', { 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        hour12: false 
                    });
                    
                    const totalMinutes = Math.round(hoursDiff * 60);
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    const durationStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                    
                    const isAbnormal = hoursDiff < 8 || hoursDiff > 13;
                    
                    // 將設備陣列轉換為分號分隔的字串
                    const equipmentStr = stat.設備.join(';');
                    
                    results.push({
                        日期: stat.工作日期,
                        廠別: stat.廠別,
                        設備: equipmentStr,
                        員工姓名: stat.員工姓名,
                        開始時間: startTimeStr,
                        結束時間: endTimeStr,
                        工作期間: durationStr, // 改名為「工作期間」
                        工時數值: hoursDiff,
                        異常狀況: isAbnormal
                    });
                });

                allProcessedData = results;
                setupFilters(results);
                
            } catch (error) {
                filterArea.innerHTML = `<div class="error">❌ 處理檔案時發生錯誤: ${error.message}</div>`;
                console.error('處理錯誤:', error);
            }
        }

        function setupFilters(data) {
            const uniqueDates = [...new Set(data.map(item => item.日期))].sort();
            const uniqueFactories = [...new Set(data.map(item => item.廠別))].sort();
            
            console.log('唯一日期:', uniqueDates);
            console.log('唯一廠別:', uniqueFactories);
            
            const filterArea = document.getElementById('filterArea');
            filterArea.innerHTML = `
                <h3>🔍 篩選條件</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label for="dateSelect">選擇日期：</label>
                        <select id="dateSelect">
                            <option value="">全部日期</option>
                            ${uniqueDates.map(date => `<option value="${date}">${date}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="factorySelect">選擇廠別：</label>
                        <select id="factorySelect">
                            <option value="">全部廠別</option>
                            ${uniqueFactories.map(factory => `<option value="${factory}">${factory}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <button class="process-btn" onclick="applyFilters()" style="background: #f39c12;">
                    📋 套用篩選並顯示結果
                </button>
            `;
        }

        function applyFilters() {
            if (!allProcessedData) {
                alert('請先處理檔案');
                return;
            }

            const selectedDate = document.getElementById('dateSelect').value;
            const selectedFactory = document.getElementById('factorySelect').value;
            
            let filteredData = allProcessedData;
            
            if (selectedDate) {
                filteredData = filteredData.filter(item => item.日期 === selectedDate);
            }
            
            if (selectedFactory) {
                filteredData = filteredData.filter(item => item.廠別 === selectedFactory);
            }
            
            // 套用排序：先依異常狀況，再依工時數值
            filteredData = sortData(filteredData);
            
            processedData = filteredData;
            displayResults(filteredData);
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('resultsContent');
            
            if (data.length === 0) {
                resultsContent.innerHTML = '<div class="error">❌ 沒有符合篩選條件的資料</div>';
                resultsDiv.style.display = 'block';
                return;
            }

            const totalEmployees = new Set(data.map(item => item.員工姓名)).size;
            const abnormalCount = data.filter(item => item.異常狀況).length;
            const normalCount = data.length - abnormalCount;
            
            const avgHours = data.reduce((sum, item) => sum + item.工時數值, 0) / data.length;

            let tableHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${data.length}</div>
                        <div class="stat-label">總記錄數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalEmployees}</div>
                        <div class="stat-label">員工人數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${normalCount}</div>
                        <div class="stat-label">正常工時</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${abnormalCount}</div>
                        <div class="stat-label">異常工時</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${avgHours.toFixed(1)}</div>
                        <div class="stat-label">平均工時</div>
                    </div>
                </div>
                
                <div class="sample-data">
                    <h4>📋 詳細資料 <small style="color: #7f8c8d;">(已排序：異常狀況優先，工作期間由少至多)</small></h4>
                    <table>
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>廠別</th>
                                <th>設備</th>
                                <th>員工姓名</th>
                                <th>開始時間</th>
                                <th>結束時間</th>
                                <th>工作期間</th>
                                <th>狀態</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.forEach(item => {
                const rowClass = item.異常狀況 ? 'abnormal-row' : '';
                const hoursClass = item.異常狀況 ? 'abnormal-hours' : 'normal-hours';
                const statusIcon = item.異常狀況 ? '⚠️' : '✅';
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${item.日期}</td>
                        <td>${item.廠別}</td>
                        <td>${item.設備}</td>
                        <td>${item.員工姓名}</td>
                        <td>${item.開始時間}</td>
                        <td>${item.結束時間}</td>
                        <td class="hours-cell ${hoursClass}">${item.工作期間}</td>
                        <td>${statusIcon}</td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="download-btn" onclick="downloadCSV()">
                        📥 下載 CSV 檔案
                    </button>
                </div>
            `;

            resultsContent.innerHTML = tableHTML;
            resultsDiv.style.display = 'block';
        }

        function downloadCSV() {
            if (!processedData || processedData.length === 0) {
                alert('沒有資料可下載');
                return;
            }

            const headers = ['日期', '廠別', '設備', '員工姓名', '開始時間', '結束時間', '工作期間', '異常狀況'];
            const csvContent = [
                headers.join(','),
                ...processedData.map(row => [
                    row.日期,
                    row.廠別,
                    row.設備,
                    row.員工姓名,
                    row.開始時間,
                    row.結束時間,
                    row.工作期間,
                    row.異常狀況 ? '異常' : '正常'
                ].join(','))
            ].join('\n');

            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', '每日作業員工時明細表.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
</body>

</html>







